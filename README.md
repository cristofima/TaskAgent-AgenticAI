# Task Agent - AI-Powered Task Management

An intelligent task management assistant built with **Microsoft Agent Framework**, **Azure OpenAI**, and **.NET Aspire**, demonstrating Clean Architecture, autonomous AI agents, and production-grade observability with Azure Content Safety protection.

![Task Agent Chat Interface](docs/screenshots/chat-interface.png)

---

## üöÄ Quick Start

```bash
# Navigate to the project
cd src

# Restore dependencies
dotnet restore

# Configure your Azure credentials in appsettings.Development.json
# Run with .NET Aspire (includes Aspire Dashboard)
dotnet run --project src/TaskAgent.AppHost

# Or run standalone
dotnet run --project src/services/TaskAgent/src/TaskAgent.WebApp
```

**Development**: Visit `http://localhost:5000` for the app and `https://localhost:17198` for Aspire Dashboard  
**Production**: Observability data flows to Azure Application Insights automatically

---

## ‚ú® Features

- üí¨ **Natural Language Interface**: Talk to your task manager like a person
- üõ°Ô∏è **Multi-Layer Security**: Azure Content Safety protection (Prompt Shield + Content Moderation)
- üìä **Production-Grade Observability**: Full OpenTelemetry stack with .NET Aspire
- ‚úÖ **Complete CRUD**: Create, read, update, and delete tasks
- ÔøΩ **Smart Analytics**: Task summaries with filtering by status and priority
- üé® **Beautiful Tables**: Markdown-formatted responses with emojis
- üí° **Contextual Suggestions**: Agent provides helpful next actions
- üóÑÔ∏è **SQL Server Persistence**: Entity Framework Core with LocalDB
- üîç **Distributed Tracing**: End-to-end request tracking with custom activity sources
- üìâ **Custom Metrics**: Real-time monitoring of AI agent operations

---

## üìä Observability & Monitoring

This project implements **production-grade observability** using .NET Aspire and OpenTelemetry with a **hybrid architecture**:

### Development Environment (Local)

![.NET Aspire Dashboard](docs/screenshots/aspire-dashboard-overview.png)

**Stack**: OpenTelemetry ‚Üí OTLP Exporter ‚Üí **Aspire Dashboard** (https://localhost:17198)

**Features**:

- üìä Real-time metrics visualization
- üîç Distributed tracing with automatic trace correlation
- üìù Structured logging with log levels and scopes
- üîó Dependency mapping (Azure OpenAI, Content Safety, SQL Server)
- üéØ Custom instrumentation for AI agent operations

### Production Environment (Azure)

**Stack**: OpenTelemetry ‚Üí Azure Monitor Exporter ‚Üí **Application Insights**

**Features**:

- üìà Performance monitoring and alerting
- üó∫Ô∏è Application Map with dependencies
- üî• Live metrics and real-time telemetry
- üìä Custom dashboards and workbooks
- üîî Smart detection and anomaly alerts

### Three Pillars of Observability

#### 1Ô∏è‚É£ Metrics (Custom + Built-in)

**Custom AI Agent Metrics**:

```csharp
Meter: "TaskAgent.Agent"

Counters:
- agent.requests         ‚Üí Total requests to the agent
- agent.function_calls   ‚Üí Function tool invocations
- agent.errors          ‚Üí Error count by type

Histograms:
- agent.response.duration ‚Üí Response time in milliseconds
```

**Built-in Metrics** (automatic):

- ASP.NET Core instrumentation (HTTP requests, response times)
- HTTP Client instrumentation (Azure OpenAI, Content Safety calls)
- Runtime instrumentation (GC, thread pool, exceptions)

#### 2Ô∏è‚É£ Distributed Tracing

**Custom Activity Sources**:

```csharp
ActivitySource: "TaskAgent.Agent"

Spans:
- Agent.ProcessMessage    ‚Üí End-to-end message processing
- Function.{FunctionName} ‚Üí Individual function tool calls

Tags:
- thread.id              ‚Üí Conversation thread identifier
- function.name          ‚Üí Called function name
- message.length         ‚Üí User message size
- response.length        ‚Üí Agent response size
```

**Built-in Traces** (automatic):

- ASP.NET Core HTTP requests
- Entity Framework Core SQL queries (development only)
- HTTP client calls to Azure services

#### 3Ô∏è‚É£ Structured Logging

**Configuration**:

- Formatted messages included
- Log scopes enabled
- Integration with OpenTelemetry
- Automatic correlation with traces

**Log Levels**:

- Information: Agent operations, function calls
- Warning: Content safety blocks, validation failures
- Error: Exceptions, service failures

### Hybrid Telemetry Architecture

**Smart Environment Detection**:

```csharp
// Automatically selects exporter based on configuration
if (OTEL_EXPORTER_OTLP_ENDPOINT exists)
    ‚Üí Use OTLP ‚Üí Aspire Dashboard

if (APPLICATIONINSIGHTS_CONNECTION_STRING exists)
    ‚Üí Use Azure Monitor ‚Üí Application Insights
```

**Security**: SQL statement capture is **disabled in production** to prevent sensitive data leakage.

**Service Discovery**: HTTPS-only in production, HTTP + HTTPS in development.

---

## üõ°Ô∏è Content Safety

This application implements **2-layer defense** using Azure AI Content Safety with **parallel execution**:

### Layer 1: Prompt Shield

- Detects prompt injection attacks (jailbreaks, instruction override, role manipulation)
- REST API: `/contentsafety/text:shieldPrompt` (API version 2024-09-01)
- Blocks malicious attempts to manipulate the AI system
- **Optimized**: Trusts Azure's pre-trained model without system context (reduces false positives)

### Layer 2: Content Moderation

- Analyzes text for harmful content (Hate, Violence, Sexual, Self-Harm)
- SDK: Azure AI Content Safety
- Configurable severity thresholds (0-6 scale)

**Architecture**: Content safety checks run automatically via middleware before any AI processing.

**Performance**:

- **Parallel Execution**: Both layers validate simultaneously using `Task.WhenAll` (~50% faster)
- **IHttpClientFactory**: Named HttpClient for optimal connection pooling and DNS refresh
- **Response Time**: ~200-400ms for safe prompts (vs ~400-800ms sequential)

**Best Practices**:

- Generic conversational refusals (like ChatGPT) - no technical details exposed
- Security violations render as normal bot messages
- No error styling for content safety blocks

**Testing**: See [docs/CONTENT_SAFETY.md](docs/CONTENT_SAFETY.md) for 75+ test cases, known limitations, and troubleshooting guide.

---

## üèóÔ∏è Architecture

Built with **Clean Architecture** for maintainability and testability:

```
TaskAgent.Domain (Entities, Business Logic)
    ‚Üì
TaskAgent.Application (Use Cases, Interfaces)
    ‚Üì
TaskAgent.Infrastructure (Data Access, Azure Services)
    ‚Üì
TaskAgent.WebApp (UI, Controllers, AI Agent)
```

**Key Components**:

- **Domain**: `TaskItem` entity with business rules, Status/Priority enums
- **Application**: DTOs (using record types), `ITaskRepository`, `IThreadPersistenceService`, 6 AI function tools
- **Infrastructure**: `TaskDbContext`, `TaskRepository`, `ContentSafetyService` with HttpClientFactory, `InMemoryThreadPersistenceService`
- **Presentation**: MVC controllers, Razor views, `TaskAgentService`, configuration validation extensions

**Conversation Persistence**:

- Thread state serialized/deserialized across requests using `AgentThread.Serialize()`
- `IThreadPersistenceService` abstraction for storage flexibility
- In-memory implementation for single-server deployments
- Production: Use Redis/SQL for multi-server scenarios

---

## üõ†Ô∏è Tech Stack

| Technology                 | Purpose                    |
| -------------------------- | -------------------------- |
| .NET 9.0                   | Modern web framework       |
| ASP.NET Core MVC           | Web application            |
| .NET Aspire                | Cloud-native orchestration |
| OpenTelemetry              | Observability framework    |
| Entity Framework Core      | Database ORM               |
| SQL Server LocalDB         | Data persistence           |
| Microsoft Agent Framework  | Autonomous AI agents       |
| Azure OpenAI (GPT-4o-mini) | Language model             |
| Azure AI Content Safety    | Security & moderation      |
| Bootstrap 5                | Responsive UI              |
| Marked.js                  | Markdown rendering         |

---

## ‚öôÔ∏è Setup

### Prerequisites

- .NET 9.0 SDK
- SQL Server LocalDB (included with Visual Studio)
- Azure OpenAI resource with deployed model (GPT-4o-mini recommended)
- Azure AI Content Safety resource
- Azure Application Insights resource (for production)

### Configuration

#### Development Environment

**1. Update `appsettings.Development.json`**:

```json
{
  "AzureOpenAI": {
    "Endpoint": "https://your-openai-resource.openai.azure.com/",
    "ApiKey": "your-openai-api-key",
    "ModelDeployment": "gpt-4o-mini"
  },
  "ContentSafety": {
    "Endpoint": "https://your-contentsafety-resource.cognitiveservices.azure.com/",
    "ApiKey": "your-contentsafety-api-key",
    "HateThreshold": 2,
    "ViolenceThreshold": 2,
    "SexualThreshold": 2,
    "SelfHarmThreshold": 2
  }
}
```

**2. Database** (auto-created on first run, or manually):

```bash
cd src/services/TaskAgent/src
dotnet ef database update --project TaskAgent.Infrastructure --startup-project TaskAgent.WebApp
```

**3. Run with Aspire** (recommended):

```bash
dotnet run --project src/TaskAgent.AppHost
```

- Application: https://localhost:5001
- Aspire Dashboard: https://localhost:17198

#### Production Environment (Azure)

**1. Update `appsettings.Production.json`**:

```json
{
  "AzureOpenAI": {
    "Endpoint": "https://your-openai-resource.openai.azure.com/",
    "ApiKey": "your-openai-api-key",
    "ModelDeployment": "gpt-4o-mini"
  },
  "ContentSafety": {
    "Endpoint": "https://your-contentsafety-resource.cognitiveservices.azure.com/",
    "ApiKey": "your-contentsafety-api-key",
    "HateThreshold": 2,
    "ViolenceThreshold": 2,
    "SexualThreshold": 2,
    "SelfHarmThreshold": 2
  },
  "APPLICATIONINSIGHTS_CONNECTION_STRING": "InstrumentationKey=your-key;IngestionEndpoint=https://...",
  "ConnectionStrings": {
    "DefaultConnection": "Server=tcp:your-server.database.windows.net,1433;Initial Catalog=TaskAgentDb;..."
  }
}
```

**2. Deploy to Azure App Service** using standard deployment methods.

---

## ü§ñ AI Agent Capabilities

The Task Agent provides 6 function tools:

| Function         | Description                                        |
| ---------------- | -------------------------------------------------- |
| `CreateTask`     | Create new tasks with title, description, priority |
| `ListTasks`      | Show all tasks with optional filters               |
| `GetTaskDetails` | Get detailed info about a specific task            |
| `UpdateTask`     | Modify task status or priority                     |
| `DeleteTask`     | Remove tasks                                       |
| `GetTaskSummary` | View statistics and analytics                      |

**Example Interactions**:

```
You: Create a high priority task to review the quarterly report
Agent: ‚úÖ Task created! ID: 1, Priority: High

You: Show me all my tasks
Agent: [Displays beautiful Markdown table with all tasks]
      üí° Suggestions: ‚Ä¢ Filter by priority ‚Ä¢ Update oldest task

You: Mark task 1 as Completed
Agent: ‚úÖ Task updated! Status changed to Completed
```

---

## üé® Agent Features

### Markdown Tables

Lists 2+ tasks in beautiful formatted tables with emojis:

- Status: ‚è≥ Pending, üîÑ InProgress, ‚úÖ Completed
- Priority: üü¢ Low, üü° Medium, üî¥ High

### Contextual Suggestions

Agent provides 1-2 smart suggestions after each operation:

- After creating: "View all tasks" or "Create follow-up"
- After listing: "Filter by priority" or "Update oldest task"
- After completing: "View remaining tasks" or "Get summary"

### Smart Insights

- Detects many pending tasks ‚Üí suggests prioritizing
- Celebrates milestones ‚Üí "üéâ Great! You've completed 5 tasks!"
- Encourages progress

---

## üìÇ Project Structure

```
TaskAgentWeb/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ TaskAgent.AppHost/                         # .NET Aspire orchestration
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AppHost.cs                            # Aspire app host configuration
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ appsettings.json                      # Aspire settings
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ TaskAgent.ServiceDefaults/                 # Shared observability configuration
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ServiceDefaultsExtensions.cs          # OpenTelemetry setup
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ services/TaskAgent/src/
‚îÇ       ‚îú‚îÄ‚îÄ TaskAgent.Domain/                      # Core business logic (NO dependencies)
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ Entities/                         # TaskItem with business rules
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ Enums/                            # TaskStatus, TaskPriority
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ Constants/                        # Domain constants
‚îÇ       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ TaskAgent.Application/                 # Use cases & interfaces
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ DTOs/                             # Record types for immutability
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ Functions/                        # 6 AI function tools
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ Interfaces/                       # ITaskRepository, IContentSafetyService
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ Telemetry/                        # Custom metrics & activity sources
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ AgentMetrics.cs               # Custom Meter
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ AgentActivitySource.cs        # Custom ActivitySource
‚îÇ       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ TaskAgent.Infrastructure/              # External concerns
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ Data/                             # TaskDbContext, EF configurations
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ Repositories/                     # Repository implementations
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ Services/                         # ContentSafetyService, ThreadPersistence
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ InfrastructureServiceExtensions.cs # HttpClientFactory, DI
‚îÇ       ‚îÇ
‚îÇ       ‚îî‚îÄ‚îÄ TaskAgent.WebApp/                      # Presentation layer
‚îÇ           ‚îú‚îÄ‚îÄ Controllers/                       # ChatController, HomeController
‚îÇ           ‚îú‚îÄ‚îÄ Services/                         # TaskAgentService (AI orchestration)
‚îÇ           ‚îú‚îÄ‚îÄ Middleware/                       # ContentSafetyMiddleware
‚îÇ           ‚îú‚îÄ‚îÄ Extensions/                       # Configuration validation
‚îÇ           ‚îú‚îÄ‚îÄ Views/                            # Razor UI
‚îÇ           ‚îú‚îÄ‚îÄ wwwroot/                          # Static assets
‚îÇ           ‚îî‚îÄ‚îÄ PresentationServiceExtensions.cs   # AI Agent registration
‚îÇ
‚îú‚îÄ‚îÄ docs/                                          # Documentation
‚îÇ   ‚îú‚îÄ‚îÄ screenshots/                              # Application screenshots
‚îÇ   ‚îú‚îÄ‚îÄ architecture/                             # Architecture diagrams (planned)
‚îÇ   ‚îî‚îÄ‚îÄ CONTENT_SAFETY.md                         # Content Safety testing guide
‚îÇ
‚îî‚îÄ‚îÄ scripts/                                       # PowerShell scripts
    ‚îú‚îÄ‚îÄ Analyze-Commits.ps1                       # Commit analysis tool
    ‚îî‚îÄ‚îÄ config.json                               # Script configuration
‚îÇ   ‚îú‚îÄ‚îÄ terraform.tfvars.example                  # Example configuration
‚îÇ   ‚îú‚îÄ‚îÄ .gitignore                                # Exclude state files
‚îÇ   ‚îî‚îÄ‚îÄ README.md                                 # Terraform documentation
‚îÇ
‚îú‚îÄ‚îÄ docs/                                          # Documentation
‚îÇ   ‚îú‚îÄ‚îÄ screenshots/                              # Application & observability screenshots
‚îÇ   ‚îú‚îÄ‚îÄ deployment/                               # Deployment guides
‚îÇ   ‚îú‚îÄ‚îÄ architecture/                             # Architecture diagrams
‚îÇ   ‚îî‚îÄ‚îÄ CONTENT_SAFETY.md                         # Security testing guide
‚îÇ
‚îî‚îÄ‚îÄ README.md                                      # This file
```

### Key Architectural Decisions

**Clean Architecture**: Domain ‚Üí Application ‚Üí Infrastructure ‚Üí WebApp (strict dependency flow)

**Observability-First**: OpenTelemetry instrumentation at every layer via ServiceDefaults

**Hybrid Telemetry**:

- Development: OTLP ‚Üí Aspire Dashboard
- Production: Azure Monitor ‚Üí Application Insights

**Security**: Content Safety middleware + HTTPS-only service discovery in production

---

## üîí Security

### Content Safety

- **2-Layer Defense**: Automatic Prompt Shield + Content Moderation
- **Fail-Secure**: Blocks requests on Prompt Shield errors; Fail-Open on Content Moderation for availability
- **Optimized Detection**: Prompt Shield uses pre-trained model (no system context) to reduce false positives
- **Performance**: HttpClientFactory with Named HttpClient for connection pooling and DNS refresh
- **Immutable DTOs**: Record types for thread-safety and proper equality semantics
- **Best Practices**: ChatGPT-style generic refusals without exposing attack details
- **See**: [docs/CONTENT_SAFETY.md](docs/CONTENT_SAFETY.md) for 75+ test cases and troubleshooting

### Application Security

- **Input Validation**: EF Core parameterized queries prevent SQL injection
- **XSS Protection**: DOMPurify sanitization on client-side
- **Configuration Validation**: Startup checks for missing credentials
- **HTTPS Enforcement**: Service discovery restricted to HTTPS in production
- **Secret Management**: Never commit API keys - use Azure Key Vault in production
- **SQL Security**: Database statement capture disabled in production

---

## üì∏ Screenshots

### .NET Aspire Dashboard (Development)

![Aspire Overview](docs/screenshots/aspire-dashboard-overview.png)
_Real-time observability with traces, metrics, and logs_

![Distributed Tracing](docs/screenshots/aspire-traces.png)
_End-to-end request tracing with custom activity sources_

![Custom Metrics](docs/screenshots/aspire-metrics.png)
_AI agent performance metrics (requests, function calls, response time)_

### Azure Application Insights (Production)

![Performance Metrics](docs/screenshots/app-insights-performance.png)
_Response time and dependency tracking_

![Distributed Tracing](docs/screenshots/app-insights-traces.png)
_Production distributed tracing_

---

## ÔøΩ Related Articles

Comprehensive guides covering concepts, best practices, and step-by-step tutorials:

1. **[Building an AI Task Management Agent using Microsoft Agentic AI Framework](https://www.c-sharpcorner.com/article/building-an-ai-task-management-agent-using-microsoft-agentic-ai-framework/)**

   - Understanding the Microsoft Agent Framework
   - Implementing autonomous AI agents with function calling
   - Clean Architecture implementation for AI applications
   - Creating Azure OpenAI resources and configuration

2. **[Securing your AI Task Agent with Azure AI Content Safety](https://www.c-sharpcorner.com/article/securing-your-ai-task-agent-with-azure-ai-content-safety/)**

   - Two-layer defense architecture (Prompt Shield + Content Moderation)
   - Setting up Azure AI Content Safety resources
   - Implementing parallel security checks for optimal performance
   - Best practices for AI security without exposing vulnerabilities

3. **[Real-Time Observability for AI Agents with .NET Aspire, Application Insights & OpenTelemetry](https://www.c-sharpcorner.com/article/real-time-observability-for-ai-agents-with-net-aspire-application-insights-o/)**
   - Production-grade observability with OpenTelemetry
   - Custom metrics and distributed tracing for AI agents
   - Hybrid telemetry architecture (local + cloud)
   - Creating Application Insights resources and configuration

---

## ÔøΩüìö Documentation

- **[Content Safety Guide](docs/CONTENT_SAFETY.md)** - Security testing with 75+ test cases
- **[Documentation Index](docs/README.md)** - Full documentation structure

---

## üìñ License

Educational sample project for learning Microsoft Agent Framework and .NET Aspire.

---

**Built with ‚ù§Ô∏è using .NET 9, Microsoft Agent Framework, .NET Aspire, and Clean Architecture**
